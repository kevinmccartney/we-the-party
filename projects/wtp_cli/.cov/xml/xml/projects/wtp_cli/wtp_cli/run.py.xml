<?xml-stylesheet type="text/xsl" href="../../../../mypy-html.xslt"?><mypy-report-file name="projects/wtp_cli/wtp_cli/run.py" module="run"><line any_info="No Anys on this line!" content="import importlib" number="1" precision="precise"/><line any_info="No Anys on this line!" content="import os" number="2" precision="precise"/><line any_info="No Anys on this line!" content="import sys" number="3" precision="precise"/><line any_info="No Anys on this line!" content="import types" number="4" precision="precise"/><line any_info="No Anys on this line!" content="import typing" number="5" precision="precise"/><line any_info="No Anys on this line!" content="" number="6" precision="empty"/><line any_info="No Anys on this line!" content="import click" number="7" precision="precise"/><line any_info="No Anys on this line!" content="import utils" number="8" precision="precise"/><line any_info="No Anys on this line!" content="from flask import Flask, request" number="9" precision="precise"/><line any_info="No Anys on this line!" content="" number="10" precision="empty"/><line any_info="No Anys on this line!" content="" number="11" precision="empty"/><line any_info="Any Types on this line: &#10;Error (x3)&#10;Unannotated (x1)" content="@utils.with_debug" number="12" precision="precise"/><line any_info="No Anys on this line!" content="def run_wtp_cli(debug: bool, port: int) -&gt; None:" number="13" precision="precise"/><line any_info="No Anys on this line!" content="    &quot;&quot;&quot;runs the wtp_cli project with optional debugging&quot;&quot;&quot;" number="14" precision="empty"/><line any_info="No Anys on this line!" content="    workspace_root = utils.wtp_workspace_root(os.getcwd())" number="15" precision="precise"/><line any_info="No Anys on this line!" content="" number="16" precision="empty"/><line any_info="No Anys on this line!" content="    os.chdir(workspace_root)" number="17" precision="precise"/><line any_info="No Anys on this line!" content="" number="18" precision="empty"/><line any_info="No Anys on this line!" content="    cli_module: types.ModuleType = importlib.import_module(" number="19" precision="precise"/><line any_info="No Anys on this line!" content="        &quot;projects.wtp_cli.wtp_cli.cli&quot;" number="20" precision="precise"/><line any_info="No Anys on this line!" content="    )" number="21" precision="empty"/><line any_info="No Anys on this line!" content="" number="22" precision="empty"/><line any_info="No Anys on this line!" content="    if os.environ.get(&quot;WTP_DEBUG&quot;) is not None:" number="23" precision="precise"/><line any_info="No Anys on this line!" content="        # TODO: find a better way of doing this - it's kinda sketchy" number="24" precision="empty"/><line any_info="No Anys on this line!" content="        old_argv = [*sys.argv]" number="25" precision="precise"/><line any_info="No Anys on this line!" content="        new_argv = [old_argv[0], *old_argv[5::]]" number="26" precision="precise"/><line any_info="No Anys on this line!" content="" number="27" precision="empty"/><line any_info="No Anys on this line!" content="        sys.argv = new_argv" number="28" precision="precise"/><line any_info="No Anys on this line!" content="" number="29" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x2)" content="        cli_module.cli()" number="30" precision="any"/><line any_info="No Anys on this line!" content="" number="31" precision="empty"/><line any_info="No Anys on this line!" content="" number="32" precision="empty"/><line any_info="No Anys on this line!" content="def start_dev_server(handler: str, port: int, debug: bool = True) -&gt; None:" number="33" precision="precise"/><line any_info="Any Types on this line: &#10;Error (x1)" content="    app = Flask(__name__)" number="34" precision="precise"/><line any_info="No Anys on this line!" content="    pid = os.getpid()" number="35" precision="precise"/><line any_info="No Anys on this line!" content="    pkg: types.ModuleType" number="36" precision="precise"/><line any_info="No Anys on this line!" content="" number="37" precision="empty"/><line any_info="No Anys on this line!" content="    utils.log_message(&quot;Starting...&quot;)" number="38" precision="precise"/><line any_info="No Anys on this line!" content="    utils.log_message(f&quot;-  {handler}&quot;)" number="39" precision="precise"/><line any_info="No Anys on this line!" content="" number="40" precision="empty"/><line any_info="No Anys on this line!" content="    utils.log_message(f&quot;Debug process pid - {pid}&quot;)" number="41" precision="precise"/><line any_info="No Anys on this line!" content="" number="42" precision="empty"/><line any_info="No Anys on this line!" content="    lambda_name = handler.split(&quot;.&quot;)[-1]" number="43" precision="precise"/><line any_info="No Anys on this line!" content="" number="44" precision="empty"/><line any_info="No Anys on this line!" content="    try:" number="45" precision="empty"/><line any_info="No Anys on this line!" content="        pkg = importlib.import_module(handler)" number="46" precision="precise"/><line any_info="No Anys on this line!" content="    except ModuleNotFoundError as ex:" number="47" precision="precise"/><line any_info="No Anys on this line!" content="        utils.log_exception(ex, message=f&quot;Module {handler} not found&quot;)" number="48" precision="precise"/><line any_info="No Anys on this line!" content="        utils.exit_process(should_log=True)" number="49" precision="precise"/><line any_info="No Anys on this line!" content="" number="50" precision="empty"/><line any_info="No Anys on this line!" content="        exit(1)" number="51" precision="precise"/><line any_info="No Anys on this line!" content="" number="52" precision="empty"/><line any_info="No Anys on this line!" content="    # TODO: move this to try/catch" number="53" precision="empty"/><line any_info="No Anys on this line!" content="    if not hasattr(pkg, &quot;lambda_handler&quot;):" number="54" precision="precise"/><line any_info="No Anys on this line!" content="        utils.log_message(" number="55" precision="precise"/><line any_info="No Anys on this line!" content="            f&quot;module '{handler}' does not have a lambda handler called 'lambda_handler'&quot;," number="56" precision="precise"/><line any_info="No Anys on this line!" content="            level=&quot;error&quot;," number="57" precision="precise"/><line any_info="No Anys on this line!" content="        )" number="58" precision="empty"/><line any_info="No Anys on this line!" content="        utils.exit_process(should_log=True)" number="59" precision="precise"/><line any_info="No Anys on this line!" content="" number="60" precision="empty"/><line any_info="No Anys on this line!" content="        exit(1)" number="61" precision="precise"/><line any_info="No Anys on this line!" content="" number="62" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x1)" content="    @app.route(f&quot;/lambdas/{lambda_name}&quot;, methods=[&quot;POST&quot;])" number="63" precision="any"/><line any_info="No Anys on this line!" content="    def post():" number="64" precision="any"/><line any_info="No Anys on this line!" content="        utils.log_message(f&quot;handler - {handler}&quot;)" number="65" precision="any"/><line any_info="No Anys on this line!" content="" number="66" precision="empty"/><line any_info="No Anys on this line!" content="        data = {}" number="67" precision="precise"/><line any_info="No Anys on this line!" content="        content_type = request.headers.get(&quot;Content-Type&quot;)" number="68" precision="any"/><line any_info="No Anys on this line!" content="" number="69" precision="empty"/><line any_info="No Anys on this line!" content="        if content_type == &quot;application/json&quot;:" number="70" precision="any"/><line any_info="Any Types on this line: &#10;Explicit (x1)&#10;Unannotated (x2)" content="            data = request.json" number="71" precision="imprecise"/><line any_info="No Anys on this line!" content="        else:" number="72" precision="empty"/><line any_info="No Anys on this line!" content="            return {&quot;body&quot;: &quot;Content-Type not supported&quot;, &quot;code&quot;: 400}" number="73" precision="any"/><line any_info="No Anys on this line!" content="" number="74" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x3)&#10;Unannotated (x6)" content="        result = pkg.lambda_handler(data[&quot;event&quot;], data[&quot;context&quot;])" number="75" precision="any"/><line any_info="No Anys on this line!" content="" number="76" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x1)" content="        return result" number="77" precision="any"/><line any_info="No Anys on this line!" content="" number="78" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x1)" content="    app.run(" number="79" precision="any"/><line any_info="No Anys on this line!" content="        debug=debug," number="80" precision="precise"/><line any_info="No Anys on this line!" content="        port=port," number="81" precision="precise"/><line any_info="No Anys on this line!" content="        use_reloader=False if debug else True," number="82" precision="precise"/><line any_info="No Anys on this line!" content="    )" number="83" precision="empty"/><line any_info="No Anys on this line!" content="" number="84" precision="empty"/><line any_info="No Anys on this line!" content="" number="85" precision="empty"/><line any_info="No Anys on this line!" content="# cli configuration" number="86" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x10)" content="@click.group(help=&quot;Run a project on a local dev server&quot;)" number="87" precision="precise"/><line any_info="No Anys on this line!" content="def run() -&gt; None:" number="88" precision="precise"/><line any_info="No Anys on this line!" content="    pass" number="89" precision="precise"/><line any_info="No Anys on this line!" content="" number="90" precision="empty"/><line any_info="No Anys on this line!" content="" number="91" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x11)" content="@click.command(help=&quot;Run an AWS lambda, isolated to the local environment&quot;)" number="92" precision="precise"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.option(" number="93" precision="any"/><line any_info="No Anys on this line!" content="    &quot;--port&quot;, &quot;-p&quot;, type=int, default=5678, help=&quot;port used to accept requests&quot;" number="94" precision="precise"/><line any_info="No Anys on this line!" content=")" number="95" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.option(" number="96" precision="any"/><line any_info="No Anys on this line!" content="    &quot;--debug&quot;," number="97" precision="precise"/><line any_info="No Anys on this line!" content="    &quot;-d&quot;," number="98" precision="precise"/><line any_info="No Anys on this line!" content="    type=bool," number="99" precision="precise"/><line any_info="No Anys on this line!" content="    default=False," number="100" precision="precise"/><line any_info="No Anys on this line!" content="    is_flag=True," number="101" precision="precise"/><line any_info="No Anys on this line!" content="    help=&quot;expose a debug port or not&quot;," number="102" precision="precise"/><line any_info="No Anys on this line!" content=")" number="103" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.argument(&quot;handler&quot;)" number="104" precision="precise"/><line any_info="No Anys on this line!" content="def aws_lambda(handler: str, port: int, debug: bool) -&gt; None:" number="105" precision="precise"/><line any_info="No Anys on this line!" content="    start_dev_server(handler=handler, debug=debug, port=port)" number="106" precision="precise"/><line any_info="No Anys on this line!" content="" number="107" precision="empty"/><line any_info="No Anys on this line!" content="" number="108" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x11)" content="@click.command(" number="109" precision="precise"/><line any_info="No Anys on this line!" content="    name=&quot;wtp_cli&quot;, help=&quot;Run an AWS lambda, isolated to the local environment&quot;" number="110" precision="precise"/><line any_info="No Anys on this line!" content=")" number="111" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.option(" number="112" precision="any"/><line any_info="No Anys on this line!" content="    &quot;--port&quot;, &quot;-p&quot;, type=int, default=5678, help=&quot;port used to accept requests&quot;" number="113" precision="precise"/><line any_info="No Anys on this line!" content=")" number="114" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.option(" number="115" precision="any"/><line any_info="No Anys on this line!" content="    &quot;--debug&quot;," number="116" precision="precise"/><line any_info="No Anys on this line!" content="    &quot;-d&quot;," number="117" precision="precise"/><line any_info="No Anys on this line!" content="    type=bool," number="118" precision="precise"/><line any_info="No Anys on this line!" content="    default=False," number="119" precision="precise"/><line any_info="No Anys on this line!" content="    is_flag=True," number="120" precision="precise"/><line any_info="No Anys on this line!" content="    help=&quot;expose a debug port or not&quot;," number="121" precision="precise"/><line any_info="No Anys on this line!" content=")" number="122" precision="empty"/><line any_info="Any Types on this line: &#10;Explicit (x13)" content="@click.argument(&quot;command&quot;, nargs=-1)" number="123" precision="any"/><line any_info="No Anys on this line!" content="def wtp_cli(command: str, port: int, debug: bool) -&gt; None:" number="124" precision="precise"/><line any_info="Any Types on this line: &#10;Error (x4)" content="    run_wtp_cli(debug=debug, port=port)" number="125" precision="any"/><line any_info="No Anys on this line!" content="" number="126" precision="empty"/><line any_info="No Anys on this line!" content="" number="127" precision="empty"/><line any_info="No Anys on this line!" content="run.add_command(aws_lambda)" number="128" precision="precise"/><line any_info="No Anys on this line!" content="run.add_command(wtp_cli)" number="129" precision="precise"/></mypy-report-file>