terraform-plan:
  working_directory: /tmp/project
  parameters:
    project:
      type: string
      description: Determines which project to plan
  docker:
    - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
  steps:
    - checkout
    - run:
        name: 'terraform plan'
        command: |
          if [ $CIRCLE_BRANCH = "master" ]; then
            tf_env="prod";
          elif [ $CIRCLE_BRANCH = 'develop' ]; then
            tf_env="dev";
          elif [[ $CIRCLE_BRANCH == feature/* ]]; then
            tf_env="feature";
          fi

          if [ '<< parameters.project >>' = 'wtp-infra' ]; then
            tf_env="";
          fi

          cd projects/<< parameters.project >>/terraform/${tf_env}

          if [ $tf_env = 'feature' ]; then
            clean_env_name=${CIRCLE_BRANCH//\//-}

            cat > variables.tfvars \<<EOF
          wtp_environment = "${clean_env_name}"
          wtp_aws_region = "us-east-1"
          EOF
          fi
          
          terraform init -input=false
          terraform plan -out tfapply